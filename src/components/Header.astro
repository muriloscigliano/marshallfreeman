---
import { siteConfig } from '@data/site';
import Button from '@components/Button.astro';

interface Props {
  hideNav?: boolean;
}

const { hideNav = false } = Astro.props;
const { navigation, name, cta } = siteConfig;
---

<header class="header" role="banner" data-scrolling-direction="up" data-scrolling-started="false">
  <nav class="header__nav container" aria-label="Main navigation">
    <a href="/" class="header__logo" aria-label={`${name} - Home`} data-header-reveal>
      <img
        src="/images/marshall-freeman-logo.svg"
        alt={name}
        class="header__logo-img"
      />
    </a>

    <!-- Desktop Navigation -->
    <div class="header__desktop">
      {!hideNav && (
        <ul class="header__menu">
          {navigation.map((item, index) => (
            <li data-header-reveal data-header-delay={index}>
              <a href={item.href} class="header__link">
                {item.label}
              </a>
            </li>
          ))}
        </ul>
      )}

      <div class="header__actions">
        {!hideNav && (
          <a href={cta.login.href} class="header__login" data-header-reveal data-header-delay={hideNav ? "0" : "4"}>
            {cta.login.label}
          </a>
        )}
        <div data-header-reveal data-header-delay={hideNav ? "1" : "5"}>
          <Button href={cta.primary.href} label={cta.primary.label} variant="secondary" size="small" />
        </div>
      </div>
    </div>

    <!-- Mobile Menu Toggle -->
    {!hideNav && (
      <button
        class="header__toggle"
        type="button"
        aria-label="Toggle menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
        data-header-reveal
        data-header-delay="1"
      >
        <span class="header__toggle-line"></span>
        <span class="header__toggle-line"></span>
      </button>
    )}
  </nav>

  <!-- Mobile Menu -->
  {!hideNav && (
    <div id="mobile-menu" class="header__mobile" aria-hidden="true">
      <div class="header__mobile-backdrop" data-mobile-close></div>
      <div class="header__mobile-panel" role="dialog" aria-modal="true" aria-label="Mobile menu">
        <nav class="header__mobile-nav container">
          <ul class="header__mobile-list">
            {navigation.map((item) => (
              <li>
                <a href={item.href} class="header__mobile-link" data-mobile-link>
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
          <div class="header__mobile-footer">
            <a href={cta.login.href} class="header__mobile-login" data-mobile-link>
              {cta.login.label}
            </a>
            <div class="header__mobile-cta" data-mobile-link>
              <Button href={cta.primary.href} label={cta.primary.label} variant="secondary" size="small" />
            </div>
          </div>
        </nav>
      </div>
    </div>
  )}
</header>

<style>
  /* Hide header elements before reveal animation */
  [data-header-reveal] {
    opacity: 0;
    transform: translateY(-10px);
  }

  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: var(--z-sticky);
    transition:
      transform 0.5s cubic-bezier(0.16, 1, 0.3, 1),
      background-color 0.3s ease,
      border-color 0.3s ease,
      box-shadow 0.3s ease,
      backdrop-filter 0.3s ease;
    transform: translateY(0) rotate(0.001deg);
    background: transparent;
    border-bottom: 1px solid transparent;
  }

  /* Add background when scrolling started */
  :global([data-scrolling-started='true']) .header {
    background: rgba(254, 255, 243, 0.78);
    backdrop-filter: blur(14px);
    border-bottom-color: var(--color-border-subtle);
    box-shadow: 0 10px 30px rgba(2, 43, 75, 0.06);
  }

  /* Hide header when scrolling down (after scroll started) */
  :global([data-scrolling-started='true'][data-scrolling-direction='down']) .header {
    transform: translateY(-100%) rotate(0.001deg);
  }

  .header__nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 72px;
    transition: height 0.3s ease;
    gap: var(--space-md);
  }

  /* Shrink nav when scrolling started */
  :global([data-scrolling-started='true']) .header__nav {
    height: 64px;
  }

  @media (min-width: 1024px) {
    .header__nav {
      height: 80px;
    }

    :global([data-scrolling-started='true']) .header__nav {
      height: 72px;
    }
  }

  .header__logo {
    display: flex;
    align-items: center;
    z-index: 10;
  }

  .header__logo-img {
    height: 28px;
    width: auto;
  }

  @media (min-width: 1024px) {
    .header__logo-img {
      height: 32px;
    }
  }

  /* Desktop Navigation */
  .header__desktop {
    display: none;
    align-items: center;
    gap: var(--space-2xl);
  }

  @media (min-width: 1024px) {
    .header__desktop {
      display: flex;
    }
  }

  .header__menu {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    padding: 0;
    border: 0;
    background: transparent;
  }

  .header__link {
    display: inline-flex;
    align-items: center;
    padding: 8px 0;
    font-size: var(--text-sm);
    font-weight: var(--font-weight-medium);
    letter-spacing: -0.01em;
    color: var(--color-text-muted);
    position: relative;
    transition:
      color var(--duration-fast) var(--ease-out-expo),
      opacity var(--duration-fast) var(--ease-out-expo);
  }

  .header__link::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: 2px;
    width: 100%;
    height: 1px;
    background: currentColor;
    opacity: 0.35;
    transform: scaleX(0);
    transform-origin: left;
    transition: transform var(--duration-base) var(--ease-out-expo);
  }

  .header__link:hover {
    color: var(--color-text);
  }

  .header__link:hover::after {
    transform: scaleX(1);
  }

  .header__actions {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
  }

  .header__login {
    display: inline-flex;
    align-items: center;
    padding: 8px 0;
    font-size: var(--text-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-muted);
    position: relative;
    transition:
      color var(--duration-fast) var(--ease-out-expo);
  }

  .header__login::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: 2px;
    width: 100%;
    height: 1px;
    background: currentColor;
    opacity: 0.35;
    transform: scaleX(0);
    transform-origin: left;
    transition: transform var(--duration-base) var(--ease-out-expo);
  }

  .header__login:hover {
    color: var(--color-text);
  }

  .header__login:hover::after {
    transform: scaleX(1);
  }

  /* Mobile Toggle */
  .header__toggle {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 6px;
    width: 32px;
    height: 32px;
    z-index: 10;
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border-subtle);
    background: rgba(254, 255, 243, 0.6);
    backdrop-filter: blur(10px);
    transition:
      background-color var(--duration-fast) var(--ease-out-expo),
      border-color var(--duration-fast) var(--ease-out-expo);
  }

  .header__toggle:hover {
    background: rgba(254, 255, 243, 0.85);
    border-color: var(--color-border);
  }

  @media (min-width: 1024px) {
    .header__toggle {
      display: none;
    }
  }

  .header__toggle-line {
    width: 24px;
    height: 1.5px;
    background: var(--color-text);
    transition: transform var(--duration-base) var(--ease-out-expo);
  }

  .header__toggle[aria-expanded='true'] .header__toggle-line:first-child {
    transform: rotate(45deg) translateY(5px);
  }

  .header__toggle[aria-expanded='true'] .header__toggle-line:last-child {
    transform: rotate(-45deg) translateY(-5px);
  }

  /* Mobile Menu */
  .header__mobile {
    position: fixed;
    inset: 0;
    background: transparent;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity var(--duration-base) var(--ease-out-expo),
      visibility var(--duration-base);
    z-index: 5;
  }

  .header__mobile[aria-hidden='false'] {
    opacity: 1;
    visibility: visible;
  }

  @media (min-width: 1024px) {
    .header__mobile {
      display: none;
    }
  }

  .header__mobile-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(2, 43, 75, 0.35);
    backdrop-filter: blur(6px);
  }

  .header__mobile-panel {
    position: relative;
    width: 100%;
    margin-top: 72px;
    background: rgba(254, 255, 243, 0.92);
    border-top: 1px solid var(--color-border-subtle);
    box-shadow: 0 30px 60px rgba(2, 43, 75, 0.12);
    transform: translateY(-8px);
    transition: transform var(--duration-base) var(--ease-out-expo);
  }

  .header__mobile[aria-hidden='false'] .header__mobile-panel {
    transform: translateY(0);
  }

  .header__mobile-nav {
    display: flex;
    flex-direction: column;
    padding-block: var(--space-lg);
  }

  .header__mobile-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
    padding-block: var(--space-sm);
  }

  .header__mobile-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 10px;
    border-radius: var(--radius-md);
    font-size: var(--text-lg);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
    letter-spacing: -0.02em;
    transition:
      background-color var(--duration-fast) var(--ease-out-expo),
      transform var(--duration-fast) var(--ease-out-expo);
  }

  .header__mobile-link:hover {
    background: rgba(2, 43, 75, 0.06);
    transform: translateX(2px);
  }

  .header__mobile-footer {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border-subtle);
    margin-top: var(--space-md);
  }

  .header__mobile-login {
    font-size: var(--text-base);
    color: var(--color-text-muted);
  }

  .header__mobile-cta {
    display: flex;
  }
</style>

<script>
  const toggle = document.querySelector('.header__toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileLinks = document.querySelectorAll('[data-mobile-link]');
  const mobileCloseTriggers = document.querySelectorAll('[data-mobile-close]');
  const desktopMediaQuery = window.matchMedia('(min-width: 1024px)');

  function closeMenu() {
    toggle?.setAttribute('aria-expanded', 'false');
    mobileMenu?.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  toggle?.addEventListener('click', () => {
    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
    toggle.setAttribute('aria-expanded', String(!isExpanded));
    mobileMenu?.setAttribute('aria-hidden', String(isExpanded));
    document.body.style.overflow = isExpanded ? '' : 'hidden';
  });

  mobileLinks.forEach((link) => {
    link.addEventListener('click', closeMenu);
  });

  mobileCloseTriggers.forEach((el) => {
    el.addEventListener('click', closeMenu);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (toggle?.getAttribute('aria-expanded') === 'true') closeMenu();
  });

  // Ensure menu is closed if viewport switches to desktop
  desktopMediaQuery.addEventListener('change', (e) => {
    if (e.matches) closeMenu();
  });

  // Close mobile menu when drawer opens
  const drawerTriggers = document.querySelectorAll('[data-drawer-open]');
  drawerTriggers.forEach((trigger) => {
    trigger.addEventListener('click', closeMenu);
  });
</script>
