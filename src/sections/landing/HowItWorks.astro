---
import { landingData } from '@data/landing';
import Button from '@components/Button.astro';

const { howItWorks } = landingData;
---

<section id={howItWorks.id} class="how-it-works" aria-labelledby="how-it-works-headline">
  <div class="how-it-works__container container">
    <header class="how-it-works__header">
      <div class="how-it-works__header-left">
        <h2 id="how-it-works-headline" class="how-it-works__headline">{howItWorks.headline} <span class="how-it-works__headline-muted">{howItWorks.headlineMuted}</span></h2>
        <p class="how-it-works__tagline">{howItWorks.tagline}</p>
      </div>
    </header>

    <div class="how-it-works__list" data-directional-hover data-type="y">
      <ol class="how-it-works__steps" role="list" aria-label="Recovery process steps">
        {howItWorks.steps.map((step) => (
          <li class="how-it-works__step" data-directional-hover-item>
            <div class="how-it-works__step-hover-tile" data-directional-hover-tile></div>
            <article class="how-it-works__step-content">
              <h3 class="how-it-works__step-title">{step.title}</h3>
              <p class="how-it-works__step-description">{step.description}</p>
            </article>
          </li>
        ))}
      </ol>
    </div>

    <footer class="how-it-works__footer">
      <Button href={howItWorks.cta.href} label={howItWorks.cta.label} variant="secondary" />
    </footer>
  </div>
</section>

<style>
  .how-it-works {
    padding-block: var(--space-section);
    background: var(--color-foreground);
  }

  .how-it-works__container {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .how-it-works__header {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .how-it-works__header-left {
    display: flex;
    flex-direction: row;
    gap: var(--space-md);
    align-items: flex-end;
    justify-content: space-between;
  }

  .how-it-works__tagline {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-subtle);
  }

  .how-it-works__tagline::before {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--color-accent);
    border-radius: 50%;
  }

  .how-it-works__headline {
    font-size: var(--text-5xl);
    font-weight: var(--font-weight-medium);
    letter-spacing: -0.03em;
    line-height: 1.05;
    max-width: 1020px;
  }

  .how-it-works__headline-muted {
    color: var(--color-text-muted);
    display: inline;
  }

  /* Steps List */
  .how-it-works__list {
    display: flex;
    flex-direction: column;
    width: 100%;
    position: relative;
  }

  .how-it-works__steps {
    display: flex;
    flex-direction: column;
  }

  .how-it-works__step {
    position: relative;
    overflow: hidden;
    border-top: 1px solid var(--color-border);
    cursor: default;
  }

  .how-it-works__step:last-child {
    border-bottom: 1px solid var(--color-border);
  }

  /* Directional hover tile */
  .how-it-works__step-hover-tile {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--color-yellow-300);
    transform: translateY(-100%);
    transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    will-change: transform;
    z-index: 0;
  }

  .how-it-works__step-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    align-items: flex-start;
    padding-block: var(--space-xl);
    padding-inline: 24px;
    transition: color 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @media (min-width: 768px) {
    .how-it-works__step-content {
      flex-direction: row;
      gap: var(--space-3xl);
      align-items: center;
    }
  }

  .how-it-works__step-title {
    font-size: var(--text-xl);
    font-weight: var(--font-weight-regular);
    color: var(--color-text);
    flex-shrink: 0;
    transition: color 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @media (min-width: 768px) {
    .how-it-works__step-title {
      width: 400px;
    }
  }

  .how-it-works__step:nth-child(n+2) .how-it-works__step-title {
    color: var(--color-text-subtle);
  }

  .how-it-works__step-description {
    font-size: var(--text-base);
    color: var(--color-text-muted);
    line-height: 1.6;
    transition: color 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @media (min-width: 768px) {
    .how-it-works__step-description {
      flex: 1;
      text-align: right;
      max-width: 480px;
      margin-left: auto;
      text-wrap: balance;
    }
  }

  /* Hover states - text becomes dark on yellow background */
  .how-it-works__step[data-status^="enter"] .how-it-works__step-title {
    color: var(--color-text);
  }

  .how-it-works__step[data-status^="enter"] .how-it-works__step-description {
    color: var(--color-text);
  }

  .how-it-works__footer {
    display: flex;
    justify-content: flex-end;
  }
</style>

<script>
  function initDirectionalListHover() {
    const directionMap: Record<string, string> = {
      top: 'translateY(-100%)',
      bottom: 'translateY(100%)',
      left: 'translateX(-100%)',
      right: 'translateX(100%)'
    };

    document.querySelectorAll('[data-directional-hover]').forEach(container => {
      const type = container.getAttribute('data-type') || 'all';

      container.querySelectorAll('[data-directional-hover-item]').forEach(item => {
        const tile = item.querySelector('[data-directional-hover-tile]') as HTMLElement;
        if (!tile) return;

        // Skip if already initialized
        if (item.hasAttribute('data-hover-initialized')) return;
        item.setAttribute('data-hover-initialized', 'true');

        item.addEventListener('mouseenter', (e) => {
          const dir = getDirection(e as MouseEvent, item as HTMLElement, type);
          tile.style.transition = 'none';
          tile.style.transform = directionMap[dir] || 'translate(0, 0)';
          void tile.offsetHeight; // Force reflow
          tile.style.transition = 'transform 0.5s cubic-bezier(0.16, 1, 0.3, 1)';
          tile.style.transform = 'translate(0%, 0%)';
          item.setAttribute('data-status', `enter-${dir}`);
        });

        item.addEventListener('mouseleave', (e) => {
          const dir = getDirection(e as MouseEvent, item as HTMLElement, type);
          item.setAttribute('data-status', `leave-${dir}`);
          tile.style.transition = 'transform 0.5s cubic-bezier(0.16, 1, 0.3, 1)';
          tile.style.transform = directionMap[dir] || 'translate(0, 0)';
        });
      });

      function getDirection(event: MouseEvent, el: HTMLElement, type: string): string {
        const { left, top, width: w, height: h } = el.getBoundingClientRect();
        const x = event.clientX - left;
        const y = event.clientY - top;

        if (type === 'y') return y < h / 2 ? 'top' : 'bottom';
        if (type === 'x') return x < w / 2 ? 'left' : 'right';

        const distances: Record<string, number> = {
          top: y,
          right: w - x,
          bottom: h - y,
          left: x
        };

        return Object.entries(distances).reduce((a, b) => (a[1] < b[1] ? a : b))[0];
      }
    });
  }

  // Initialize immediately if DOM is ready, otherwise wait
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDirectionalListHover);
  } else {
    initDirectionalListHover();
  }

  // Also listen for intro complete in case it fires later
  window.addEventListener('introComplete', initDirectionalListHover, { once: true });
</script>
