---
import { landingData } from '@data/landing';

const { platformFeatures } = landingData;

const icons: Record<string, string> = {
  grid: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>`,
  workflow: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
  users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  chart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
  lock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
  user: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
};
---

<section class="features" aria-labelledby="features-headline">
  <div class="features__container container">
    <header class="features__header">
      <p class="features__tagline">{platformFeatures.tagline}</p>
      <h2 id="features-headline" class="features__headline">{platformFeatures.headline} <span class="features__headline-muted">{platformFeatures.headlineMuted}</span></h2>
    </header>

    <ul class="features__grid" role="list" aria-label="Platform features">
      {platformFeatures.items.map((item) => (
        <li class="features__card" data-direction-aware>
          <!-- Default content (dark text) -->
          <article class="features__card-content">
            <div class="features__icon" aria-hidden="true" set:html={icons[item.icon]} />
            <h3 class="features__title">{item.title}</h3>
            <p class="features__description">{item.description}</p>
          </article>
          <!-- Hover content (light text) - clipped with highlight -->
          <div class="features__card-highlight" aria-hidden="true">
            <article class="features__card-content features__card-content--hover">
              <div class="features__icon" set:html={icons[item.icon]} />
              <h3 class="features__title">{item.title}</h3>
              <p class="features__description">{item.description}</p>
            </article>
          </div>
        </li>
      ))}
    </ul>
  </div>
</section>

<style>
  .features {
    padding-block: var(--space-section);
  }

  .features__container {
    display: flex;
    flex-direction: column;
    gap: var(--space-3xl);
  }

  .features__header {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .features__tagline {
    font-size: var(--text-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-subtle);
  }

  .features__headline {
    font-size: var(--text-5xl);
    font-weight: var(--font-weight-medium);
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .features__headline-muted {
    color: var(--color-text-muted);
  }

  .features__grid {
    display: grid;
    grid-template-columns: 1fr;
    border: 1px solid var(--color-border);
  }

  @media (min-width: 640px) {
    .features__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .features__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .features__card {
    position: relative;
    border: 1px solid var(--color-border);
    margin: -1px;
    overflow: hidden;
  }

  /* Direction-aware highlight */
  .features__card-highlight {
    position: absolute;
    inset: 8px;
    border-radius: 6px;
    background: var(--color-accent);
    pointer-events: none;
    z-index: 2;
    clip-path: inset(0 100% 0 0);
    transition: clip-path 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
  }

  @media (max-width: 639px) {
    .features__card-highlight {
      display: none;
    }
  }

  .features__card-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    padding: var(--space-xl);
    min-height: 200px;
  }

  /* Hover content inside highlight - offset to align with original */
  .features__card-content--hover {
    position: absolute;
    top: -8px;
    left: -8px;
    right: -8px;
    bottom: -8px;
    z-index: 3;
  }

  .features__card-content--hover .features__icon,
  .features__card-content--hover .features__title,
  .features__card-content--hover .features__description {
    color: var(--color-background);
  }

  @media (min-width: 768px) {
    .features__card-content {
      padding: var(--space-2xl);
      min-height: 240px;
    }
  }

  .features__icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text);
  }

  .features__icon :global(svg) {
    width: 24px;
    height: 24px;
  }

  .features__title {
    font-size: var(--text-lg);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
  }

  .features__description {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    line-height: 1.6;
    flex: 1;
  }
</style>

<script>
  function initDirectionAwareHover() {
    const cards = document.querySelectorAll('.features__card[data-direction-aware]');

    cards.forEach((card) => {
      const highlight = card.querySelector('.features__card-highlight') as HTMLElement;
      if (!highlight) return;

      // Get direction based on which edge the mouse crossed
      const getDirection = (e: MouseEvent, rect: DOMRect): string => {
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Calculate distances to each edge
        const distTop = y;
        const distBottom = rect.height - y;
        const distLeft = x;
        const distRight = rect.width - x;

        const minDist = Math.min(distTop, distBottom, distLeft, distRight);

        if (minDist === distTop) return 'top';
        if (minDist === distBottom) return 'bottom';
        if (minDist === distLeft) return 'left';
        return 'right';
      };

      // clip-path: inset(top right bottom left)
      // Get clip-path for hidden state based on direction (reveals from that edge)
      const getHiddenClipPath = (direction: string): string => {
        switch (direction) {
          case 'top': return 'inset(0 0 100% 0)';    // clipped at bottom, reveals from top
          case 'bottom': return 'inset(100% 0 0 0)'; // clipped at top, reveals from bottom
          case 'left': return 'inset(0 100% 0 0)';   // clipped at right, reveals from left
          case 'right': return 'inset(0 0 0 100%)';  // clipped at left, reveals from right
          default: return 'inset(0 100% 0 0)';
        }
      };

      card.addEventListener('mouseenter', (e) => {
        const rect = card.getBoundingClientRect();
        const direction = getDirection(e as MouseEvent, rect);

        // Set starting clip-path instantly (hidden)
        highlight.style.transition = 'none';
        highlight.style.clipPath = getHiddenClipPath(direction);

        // Force reflow
        highlight.offsetHeight;

        // Animate to fully visible
        highlight.style.transition = 'clip-path 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
        highlight.style.clipPath = 'inset(0 0 0 0)';
      });

      card.addEventListener('mouseleave', (e) => {
        const rect = card.getBoundingClientRect();
        const direction = getDirection(e as MouseEvent, rect);

        // Animate out in the exit direction
        highlight.style.transition = 'clip-path 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
        highlight.style.clipPath = getHiddenClipPath(direction);
      });
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDirectionAwareHover);
  } else {
    initDirectionAwareHover();
  }

  document.addEventListener('astro:page-load', initDirectionAwareHover);
</script>
